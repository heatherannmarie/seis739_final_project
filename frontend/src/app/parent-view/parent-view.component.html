<div class="layout">
    <nav class="sidebar">
        <ul>
            <li><a (click)="activeComponent = 'children'" [class.active]="activeComponent === 'children'">Children</a></li>
            <li><a (click)="activeComponent = 'chores'" [class.active]="activeComponent === 'chores'">Chores</a></li>
            <li><a (click)="activeComponent = 'store'" [class.active]="activeComponent === 'store'">Store</a></li>
            <li><a (click)="activeComponent = 'transactions'"
                    [class.active]="activeComponent === 'transactions'">Transaction History</a></li>
        </ul>
    </nav>

    <main class="content">
        @if (activeComponent === 'children') {
        <section id="page-title">
            <h1>Manage Children</h1>
            <button id="add-child-btn" (click)="openNewChildAccountModal()">+ Create Child Account</button>


            @if (showNewChildAccountModal) {
            <div class="modal-overlay" (click)="closeNewChildAccountModal()">
                <div class="modal-content" (click)="$event.stopPropagation()">
                    <div class="add-child-form">
                        <h3>Add New Child</h3>
                        <form (ngSubmit)="createChildOnSubmit()">
                            <div class="form-group">
                                <label for="newChildName">Name</label>
                                <input type="text" id="newChildName" [(ngModel)]="newChildName" name="newChildName"
                                    required>
                            </div>
                            <div class="form-group">
                                <label for="newChildUsername">Username</label>
                                <input type="text" id="newChildUsername" [(ngModel)]="newChildUsername"
                                    name="newChildUsername" required>
                            </div>
                            <div class="modal-actions">
                                <button type="submit" class="add-btn">Add Child</button>
                                <button type="button" (click)="closeNewChildAccountModal()"
                                    class="cancel-btn">Cancel</button>

                            </div>
                        </form>
                    </div>
                </div>
            </div>
            }
        </section>
        
        <div class="child-grid">
            @for (child of children; track child.childId) {
            <div class="child-card">
                @if (editingChild?.childId === child.childId) {
                <form (ngSubmit)="saveChildEdit()">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" [(ngModel)]="editChildName" name="editChildName" required>
                    </div>
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" [(ngModel)]="editChildUsername" name="editChildUsername" required>
                    </div>
                    <div class="edit-actions">
                        <button type="submit" class="save-btn">Save</button>
                        <button type="button" (click)="cancelChildEdit()" class="cancel-btn">Cancel</button>
                    </div>
                </form>
                } @else {
                <div class="child-header">
                    <div class="child-avatar">{{ child.name.charAt(0).toUpperCase() }}</div>
                    <div class="child-info">
                        <h3>{{ child.name }}</h3>
                        <p class="username">&#64;{{ child.username }}</p>
                    </div>
                </div>

                <div class="child-balance">
                    <span class="balance-label">Balance</span>
                    <span class="balance-amount">${{ child.balance.toFixed(2) }}</span>
                </div>

                <p class="child-id">ID: {{ child.childId }}</p>

                <div class="child-actions">
                    <button (click)="startChildEdit(child)" class="action-btn edit-btn">Edit</button>
                    <button (click)="viewChildPin(child)" class="action-btn pin-btn">View PIN</button>
                    <button (click)="openAllowanceModal(child)" class="action-btn allowance-btn">Send Allowance</button>
                    <button (click)="viewChildTransactions(child)" class="action-btn history-btn">Transactions</button>
                    <button (click)="viewChildChores(child)" class="action-btn chores-btn">Chores</button>
                </div>
                }
            </div>
            }
        </div>


        }

        @if (activeComponent === 'chores') {
        <app-chore-list [chores]="chores" mode="parent"></app-chore-list>
        }

        @if (activeComponent === 'store') {
        <app-storefront></app-storefront>
        }

        @if (activeComponent === 'transactions') {
        <app-transactions [transactions]="transactions"></app-transactions>
        }
    </main>
</div>

<!-- Allowance Modal -->
@if (showAllowanceModal && selectedChild) {
<div class="modal-overlay" (click)="closeAllowanceModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <h2>Send Allowance to {{ selectedChild.name }}</h2>
        <p class="current-balance">Current Balance: ${{ selectedChild.balance.toFixed(2) }}</p>

        <form (ngSubmit)="sendAllowance()">
            <div class="form-group">
                <label for="allowanceAmount">Amount ($)</label>
                <input type="number" id="allowanceAmount" [(ngModel)]="allowanceAmount" name="allowanceAmount"
                    step="0.01" placeholder="Enter Allowance Amount" required />
            </div>
            <div class="modal-actions">
                <button type="submit" class="send-btn">Send</button>
                <button type="button" (click)="closeAllowanceModal()" class="cancel-btn">Cancel</button>
            </div>
        </form>
    </div>
</div>
}

<!-- Transactions Modal -->
@if (showTransactionsModal && selectedChild) {
<div class="modal-overlay" (click)="closeTransactionsModal()">
    <div class="modal-content modal-large" (click)="$event.stopPropagation()">
        <h2>{{ selectedChild.name }}'s Transactions</h2>
        <p class="current-balance">Current Balance: ${{ selectedChild.balance.toFixed(2) }}</p>

        @if (childTransactions.length === 0) {
        <p class="no-data">No transactions yet.</p>
        } @else {
        <table class="transaction-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Type</th>
                    <th>Description</th>
                    <th>Amount</th>
                </tr>
            </thead>
            <tbody>
                @for (transaction of childTransactions; track transaction.id) {
                <tr [class]="transaction.type === 'ALLOWANCE' ? 'income' : 'expense'">
                    <td>{{ formatDate(transaction.timestamp) }}</td>
                    <td>{{ transaction.type }}</td>
                    <td>{{ transaction.description }}</td>
                    <td [class]="transaction.type === 'ALLOWANCE' ? 'positive' : 'negative'">
                        {{ transaction.type === 'ALLOWANCE' ? '+' : '-' }}${{ transaction.amount.toFixed(2) }}
                    </td>
                </tr>
                }
            </tbody>
        </table>
        }

        <div class="modal-actions">
            <button type="button" (click)="closeTransactionsModal()" class="close-btn">Close</button>
        </div>
    </div>
</div>
}

<!-- Chores Modal -->
@if (showChoresModal && selectedChild) {
<div class="modal-overlay" (click)="closeChoresModal()">
    <div class="modal-content modal-large" (click)="$event.stopPropagation()">
        <h2>{{ selectedChild.name }}'s Chores</h2>

        @if (childChores.length === 0) {
        <p class="no-data">No chores assigned to this child.</p>
        } @else {
        <div class="chores-list">
            @for (chore of childChores; track chore.choreId) {
            <div class="chore-item" [class]="'status-' + chore.status.toLowerCase()">
                <div class="chore-info">
                    <h4>{{ chore.choreName }}</h4>
                    <p>{{ chore.choreDescription }}</p>
                    <p class="chore-price">${{ chore.chorePrice.toFixed(2) }}</p>
                </div>
                <div class="chore-status">
                    <span class="status-badge">{{ chore.status }}</span>
                    @if (chore.status === 'PENDING') {
                    <div class="chore-actions">
                        <button (click)="approveChoreFromModal(chore.choreId)" class="approve-btn">Approve</button>
                        <button (click)="denyChoreFromModal(chore.choreId)" class="deny-btn">Deny</button>
                    </div>
                    }
                </div>
            </div>
            }
        </div>
        }

        <div class="modal-actions">
            <button type="button" (click)="closeChoresModal()" class="close-btn">Close</button>
        </div>
    </div>
</div>
}

<!-- PIN Modal -->
@if (showPinModal && selectedChild) {
<div class="modal-overlay" (click)="closePinModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <h2>{{ selectedChild.name }}'s Login Credentials</h2>

        <div class="credentials-display">
            <div class="credential-item">
                <span class="credential-label">Username</span>
                <span class="credential-value">{{ selectedChild.username }}</span>
            </div>
            <div class="credential-item">
                <span class="credential-label">PIN</span>
                <span class="credential-value pin-display">{{ currentPin }}</span>
            </div>
        </div>

        <p class="credential-note">Share these credentials with your child so they can log in.</p>

        <div class="modal-actions">
            <button type="button" (click)="regeneratePin()" class="regenerate-btn">Regenerate PIN</button>
            <button type="button" (click)="closePinModal()" class="close-btn">Close</button>
        </div>
    </div>
</div>
}

<!-- New Child Created PIN Modal -->
@if (showNewChildPinModal && newChildCreated) {
<div class="modal-overlay">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <h2>Child Account Created!</h2>

        <p class="success-message">{{ newChildCreated.name }}'s account has been created successfully.</p>

        <div class="credentials-display">
            <div class="credential-item">
                <span class="credential-label">Username</span>
                <span class="credential-value">{{ newChildCreated.username }}</span>
            </div>
            <div class="credential-item">
                <span class="credential-label">PIN</span>
                <span class="credential-value pin-display">{{ newChildPin }}</span>
            </div>
        </div>

        <p class="credential-note warning">Please save these credentials! You can view them later from the child's card,
            but make sure to share them with your child.</p>

        <div class="modal-actions">
            <button type="button" (click)="closeNewChildPinModal()" class="close-btn">Got It!</button>
        </div>
    </div>
</div>
}